{% extends 'base.html' %}

{% block content %}
<div class="container" style="margin-top: 50px;">

    <!-- Dashboard Header -->
    <div class="card dashboard-header-responsive"
        style="margin-bottom: 30px; padding: 40px; border-radius: 30px; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(255,255,255,0.01) 100%);">
        <div class="header-main" style="display: flex; align-items: center; gap: 20px;">
            <div class="header-icon"
                style="background: var(--primary-color); width: 70px; height: 70px; border-radius: 20px; display: flex; align-items: center; justify-content: center; color: #000;">
                <i class="fas fa-gavel" style="font-size: 2.2rem;"></i>
            </div>
            <div>
                <h1 class="header-title" style="font-size: 2rem; font-weight: 800; color: #fff; margin: 0;">لوحة تحكم
                    القضاء</h1>
                <p class="header-subtitle" style="color: var(--text-muted); margin: 5px 0 0; font-size: 1.1rem;">أهلاً
                    بك، فضيلة القاضي {{
                    user.get_full_name|default:user.username }}</p>
            </div>
        </div>
        <a href="{% url 'judges:manage_clerks' %}" class="btn-primary header-action"
            style="padding: 0.8rem 2rem; font-size: 1.05rem; border-radius: 12px;">
            <i class="fas fa-users-cog"></i> إدارة التشكيل الإداري
        </a>
    </div>

    <!-- New Assigned Cases (Grid) -->
    <div style="margin-bottom: 60px;">
        <h3
            style="margin-bottom: 30px; color: #fff; font-weight: 800; display: flex; align-items: center; gap: 15px; font-size: 1.6rem;">
            <i class="fas fa-plus-circle" style="color: var(--primary-color);"></i> الطلبات الواردة حديثاً
        </h3>

        {% if new_cases %}
        <div class="dashboard-grid">
            {% for case in new_cases %}
            <div class="card"
                style="border-radius: 25px; display: flex; flex-direction: column; justify-content: space-between; border-left: 4px solid var(--primary-color);">
                <div style="margin-bottom: 25px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <span
                            style="background: rgba(212, 175, 55, 0.1); color: var(--primary-color); padding: 5px 12px; border-radius: 6px; font-weight:700; font-size: 0.9rem;">قضية
                            رقم: {{ case.case_number }}</span>
                        <span class="badge badge-pending">بانتظار القبول</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.95rem; margin: 5px 0;"><i class="fas fa-clock"
                            style="margin-left: 8px; opacity:0.5;"></i> {{ case.created_at|date:"Y-m-d" }}</p>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 10px;">
                    <form method="post" action="{% url 'judges:accept_case' case.id %}" style="flex: 1;">
                        {% csrf_token %}
                        <button type="submit" class="btn-primary"
                            style="width: 100%; border-radius: 10px; padding: 0.7rem; font-size: 0.95rem;">إقرار
                            القبول</button>
                    </form>
                    <form method="post" action="{% url 'judges:reject_case' case.id %}" style="flex: 1;">
                        {% csrf_token %}
                        <button type="submit" class="btn-outline"
                            style="width: 100%; border-radius: 10px; padding: 0.7rem; font-size: 0.95rem;">رفض</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info"
            style="background: rgba(255,255,255,0.02); border: 1px dashed var(--glass-border); text-align: center; color: var(--text-muted); font-size: 1.1rem; padding: 40px; border-radius: 20px;">
            <i class="fas fa-info-circle" style="margin-left: 10px;"></i> لا توجد قضايا جديدة بانتظار القبول حالياً.
        </div>
        {% endif %}
    </div>

    <!-- Active Cases (Accepted but Waiting for Clerk/Action) -->
    <div style="margin-bottom: 60px;">
        <h3
            style="margin-bottom: 30px; color: #fff; font-weight: 800; display: flex; align-items: center; gap: 15px; font-size: 1.6rem;">
            <i class="fas fa-folder-open" style="color: var(--primary-color);"></i> قضايا تحت الإجراء
        </h3>
        {% if active_cases %}
        <div class="table-container">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr style="background: rgba(212, 175, 55, 0.04);">
                            <th style="padding: 20px;">رقم القضية</th>
                            <th style="padding: 20px;">الحالة الحالية</th>
                            <th style="padding: 20px;">تاريخ القبول</th>
                            <th style="padding: 20px;">العمليات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for case in active_cases %}
                        {% if case.status != 'DATA_REVIEW' and case.status != 'SESSION_ACTIVE' %}
                        <tr>
                            <td style="padding: 20px; font-weight: 800; color: #fff;">{{ case.case_number }}</td>
                            <td style="padding: 20px; color: #ddd;">
                                {% if case.clerk %}
                                <span class="badge badge-info">عند الكاتب: {{ case.clerk.first_name }}</span>
                                {% else %}
                                <span class="badge badge-warning">بانتظار تعيين كاتب</span>
                                {% endif %}
                            </td>
                            <td style="padding: 20px; color: var(--text-muted);">{{ case.updated_at|date:"Y-m-d" }}</td>
                            <td style="padding: 20px; display: flex; gap: 10px;">
                                <a href="{% url 'judges:assign_clerk' case.id %}" class="btn-outline"
                                    style="padding: 0.5rem 1rem; font-size: 0.85rem; border-radius: 8px;">
                                    <i class="fas fa-user-plus"></i> تعيين كاتب
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <p
            style="color: var(--text-muted); text-align: center; padding: 40px; background: rgba(255,255,255,0.01); border-radius: 20px;">
            لا توجد قضايا تحت الإجراء حالياً.</p>
        {% endif %}
    </div>

    <!-- Review Section (Table) -->
    <div style="margin-bottom: 60px;">
        <h3
            style="margin-bottom: 30px; color: #fff; font-weight: 800; display: flex; align-items: center; gap: 15px; font-size: 1.6rem;">
            <i class="fas fa-search" style="color: var(--primary-color);"></i> مراجعة بيانات التركات
        </h3>
        {% if review_cases %}
        <div class="table-container">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr style="background: rgba(212, 175, 55, 0.04);">
                            <th style="padding: 20px;">رقم القضية</th>
                            <th style="padding: 20px;">الكاتب المكلف</th>
                            <th style="padding: 20px;">آخر تحديث</th>
                            <th style="padding: 20px;">العمليات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for case in review_cases %}
                        <tr>
                            <td style="padding: 20px; font-weight: 800; color: #fff;">{{ case.case_number }}</td>
                            <td style="padding: 20px; color: #ddd;">{{
                                case.clerk.get_full_name|default:case.clerk.username }}</td>
                            <td style="padding: 20px; color: var(--text-muted);">
                                {{ case.updated_at|default:case.created_at|date:"Y-m-d" }}</td>
                            <td style="padding: 20px;">
                                <a href="{% url 'judges:case_details' case.id %}" class="btn-primary"
                                    style="padding: 0.5rem 1.5rem; font-size: 0.9rem; border-radius: 8px;">
                                    <i class="fas fa-file-signature"></i> مراجعة وتدقيق
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <p
            style="color: var(--text-muted); text-align: center; padding: 40px; background: rgba(255,255,255,0.01); border-radius: 20px;">
            لا توجد ملفات بانتظار المراجعة.</p>
        {% endif %}
    </div>

    <!-- Active Sessions (Special Cards) -->
    <div style="margin-bottom: 60px;">
        <h3
            style="margin-bottom: 30px; color: #fff; font-weight: 800; display: flex; align-items: center; gap: 15px; font-size: 1.6rem;">
            <i class="fas fa-balance-scale" style="color: var(--primary-color);"></i> جلسات القسمة الجارية
        </h3>
        {% if session_cases %}
        <div class="dashboard-grid">
            {% for case in session_cases %}
            <div class="card" style="border-radius: 25px; border-top: 5px solid var(--primary-color);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h4 style="margin: 0; font-size: 1.4rem; font-weight: 800;">قضية: {{ case.case_number }}</h4>
                    <span style="font-size: 0.9rem; color: var(--text-muted);"><i class="fas fa-calendar"></i> {{
                        case.updated_at|date:"Y-m-d" }}</span>
                </div>

                <div
                    style="margin-bottom: 30px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border: 1px solid var(--glass-border);">
                    <label
                        style="font-size: 0.85rem; color: var(--primary-color); font-weight: 700; margin-bottom: 10px; display: block;">رابط
                        الجلسة الموحد للورثة:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text"
                            value="{{ request.scheme }}://{{ request.get_host }}/heirs/session/{{ case.session_link }}/"
                            readonly
                            style="background: transparent; border: none; color: #fff; font-size: 0.85rem; flex: 1; outline: none;">
                        <button
                            style="background: var(--primary-color); border: none; color: #000; padding: 5px 12px; border-radius: 6px; font-weight: 800; cursor: pointer; font-size: 0.8rem;"
                            onclick="navigator.clipboard.writeText('{{ request.scheme }}://{{ request.get_host }}/heirs/session/{{ case.session_link }}/'); this.innerText='تم النسخ'">نسخ</button>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <a href="{% url 'judges:allocate_assets' case.id %}" class="btn-primary"
                        style="width: 100%; border-radius: 10px;">إدارة التوزيع اليدوي</a>
                    <a href="{% url 'review_distribution' case.id %}" class="btn-outline"
                        style="width: 100%; border-radius: 10px; border-style: dashed;">موازنة التراضي (التوزيع
                        الحر)</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p
            style="color: var(--text-muted); text-align: center; padding: 40px; background: rgba(255,255,255,0.01); border-radius: 20px;">
            لا توجد جلسات مفتوحة حالياً.</p>
        {% endif %}
    </div>

</div>

<style>
    @media (max-width: 992px) {
        .container {
            margin-top: 20px !important;
        }

        .dashboard-header-responsive {
            flex-direction: column;
            align-items: center !important;
            text-align: center !important;
            gap: 25px;
            padding: 30px 20px !important;
            margin-bottom: 30px !important;
        }

        .header-main {
            flex-direction: column !important;
            gap: 15px !important;
        }

        .header-icon {
            margin: 0 auto !important;
            width: 60px !important;
            height: 60px !important;
        }

        .header-icon i {
            font-size: 1.8rem !important;
        }

        .header-title {
            font-size: 1.6rem !important;
        }

        .header-subtitle {
            font-size: 0.95rem !important;
        }

        .header-action {
            width: 100% !important;
            padding: 12px !important;
        }

        .dashboard-grid {
            grid-template-columns: 1fr !important;
            gap: 20px !important;
        }

        .card {
            padding: 30px 20px !important;
            border-radius: 20px !important;
        }

        h3 {
            font-size: 1.3rem !important;
            margin-bottom: 20px !important;
        }

        .table-container {
            border-radius: 15px !important;
        }

        th,
        td {
            padding: 15px 12px !important;
            font-size: 0.9rem !important;
        }

        .btn-outline,
        .btn-primary {
            font-size: 0.85rem !important;
            padding: 10px !important;
        }
    }
</style>
{% endblock %}